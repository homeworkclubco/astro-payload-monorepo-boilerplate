---
import BaseLayout from "./BaseLayout.astro";
import type { PreviewLayoutProps } from "src/types/layout";

interface Props extends PreviewLayoutProps {}

const { title, description, payloadUrl, error, lang } = Astro.props;
---

<BaseLayout title={title} description={description} lang={lang} noIndex={true}>
  <!-- Payload URL for client script access -->
  <div id="payload-config" data-url={payloadUrl} style="display: none;"></div>

  {
    error && (
      <div class="preview-error">
        <strong>Preview Error:</strong> {error}
      </div>
    )
  }

  <slot />

  <!-- Live Preview Client Script -->
  <script>
    import { isDocumentEvent, ready } from "@payloadcms/live-preview";

    const configEl = document.getElementById("payload-config");
    const serverURL = configEl?.dataset.url || "http://localhost:3000";

    function sendReady() {
      ready({ serverURL });
    }

    function onMessage(event: MessageEvent) {
      if (isDocumentEvent(event, serverURL)) {
        window.location.reload();
      }
    }

    window.addEventListener("message", onMessage);

    if (document.readyState === "loading") {
      window.addEventListener("DOMContentLoaded", sendReady, { once: true });
    } else {
      sendReady();
    }
  </script>
</BaseLayout>

<style>
  .preview-error {
    padding: 1rem;
    color: #dc2626;
    background: #fef2f2;
    border: 2px solid #dc2626;
    margin: 1rem;
    border-radius: 4px;
  }
</style>
