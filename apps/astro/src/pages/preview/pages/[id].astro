---
export const prerender = false;

import PreviewLayout from "src/layouts/PreviewLayout.astro";
import { getPayloadEnv, getAuthHeaders } from "src/lib/payload-config";
import type { Page } from "src/types/payload";

const env = getPayloadEnv(Astro);
const { id } = Astro.params;

let page: Page | null = null;
let error: string | null = null;

const headers = getAuthHeaders(env, Astro.request.headers.get("Cookie"));
headers.cache = "no-store";

try {
  const response = await fetch(
    `${env.payloadUrl}/api/pages/${id}?draft=true&depth=2`,
    { headers },
  );

  if (response.ok) {
    page = await response.json();
  } else {
    error = `Failed to fetch preview: ${response.statusText}`;
  }
} catch (e) {
  error = `Error: ${e instanceof Error ? e.message : String(e)}`;
}
---

<PreviewLayout
  title={page?.title}
  payloadUrl={env.payloadUrl}
  error={error}
>
  {
    page && (
      <article>
        <h1>{page.title}</h1>
        <div>{JSON.stringify(page.body)}</div>
      </article>
    )
  }
</PreviewLayout>
